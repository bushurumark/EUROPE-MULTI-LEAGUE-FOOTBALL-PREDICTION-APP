{% extends 'predictor/base.html' %}

{% block title %}Historical Probabilities - {{ team1 }} vs {{ team2 }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4">Historical Probabilities</h2>
            
            <!-- Team Selection Form -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Select Teams</h5>
                </div>
                <div class="card-body">
                    <form id="teamSelectionForm">
                        <div class="row">
                            <div class="col-md-5">
                                <label for="team1" class="form-label">Team 1</label>
                                <select class="form-select" id="team1" name="team1" required>
                                    <option value="">Select Team 1</option>
                                    <option value="Arsenal">Arsenal</option>
                                    <option value="Chelsea">Chelsea</option>
                                    <option value="Manchester United">Manchester United</option>
                                    <option value="Liverpool">Liverpool</option>
                                    <option value="Manchester City">Manchester City</option>
                                    <option value="Tottenham">Tottenham</option>
                                    <option value="Everton">Everton</option>
                                    <option value="West Ham">West Ham</option>
                                    <option value="Leicester">Leicester</option>
                                    <option value="Aston Villa">Aston Villa</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end justify-content-center">
                                <span class="h4">vs</span>
                            </div>
                            <div class="col-md-5">
                                <label for="team2" class="form-label">Team 2</label>
                                <select class="form-select" id="team2" name="team2" required>
                                    <option value="">Select Team 2</option>
                                    <option value="Arsenal">Arsenal</option>
                                    <option value="Chelsea">Chelsea</option>
                                    <option value="Manchester United">Manchester United</option>
                                    <option value="Liverpool">Liverpool</option>
                                    <option value="Manchester City">Manchester City</option>
                                    <option value="Tottenham">Tottenham</option>
                                    <option value="Everton">Everton</option>
                                    <option value="West Ham">West Ham</option>
                                    <option value="Leicester">Leicester</option>
                                    <option value="Aston Villa">Aston Villa</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12 text-center">
                                <button type="submit" class="btn btn-primary">Get Historical Data</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading historical data...</p>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="d-none">
                <div class="row">
                    <!-- Head-to-Head Summary -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5>Head-to-Head Summary</h5>
                            </div>
                            <div class="card-body">
                                <div id="h2hSummary">
                                    <!-- Content will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Win Rates Chart -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5>Win Rates</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="winRatesChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Match History Table -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Match History</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="matchHistoryTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Date</th>
                                                <th>Home Team</th>
                                                <th>Score</th>
                                                <th>Away Team</th>
                                                <th>Winner</th>
                                                <th>Result</th>
                                            </tr>
                                        </thead>
                                        <tbody id="matchHistoryBody">
                                            <!-- Content will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Form Analysis -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Recent Form Analysis</h5>
                            </div>
                            <div class="card-body">
                                <div id="recentFormAnalysis">
                                    <!-- Content will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="alert alert-danger d-none" role="alert">
                <h5>Error</h5>
                <p id="errorText"></p>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('teamSelectionForm');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultsSection = document.getElementById('resultsSection');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    
    let winRatesChart = null;

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const team1 = document.getElementById('team1').value;
        const team2 = document.getElementById('team2').value;
        
        if (!team1 || !team2) {
            showError('Please select both teams');
            return;
        }
        
        if (team1 === team2) {
            showError('Please select different teams');
            return;
        }
        
        loadHistoricalData(team1, team2);
    });

    function loadHistoricalData(team1, team2) {
        // Show loading spinner
        loadingSpinner.classList.remove('d-none');
        resultsSection.classList.add('d-none');
        errorMessage.classList.add('d-none');
        
        // Make API call
        fetch(`/api/historical-probabilities/?team1=${encodeURIComponent(team1)}&team2=${encodeURIComponent(team2)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                displayResults(data, team1, team2);
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Failed to load historical data: ' + error.message);
            })
            .finally(() => {
                loadingSpinner.classList.add('d-none');
            });
    }

    function displayResults(data, team1, team2) {
        // Display head-to-head summary
        displayH2HSummary(data, team1, team2);
        
        // Create win rates chart
        createWinRatesChart(data, team1, team2);
        
        // Display match history table
        displayMatchHistory(data.match_history);
        
        // Display recent form analysis
        displayRecentForm(data.recent_form, team1, team2);
        
        // Show results
        resultsSection.classList.remove('d-none');
    }

    function displayH2HSummary(data, team1, team2) {
        const summaryDiv = document.getElementById('h2hSummary');
        
        const html = `
            <div class="row text-center">
                <div class="col-4">
                    <h6>${team1}</h6>
                    <h4 class="text-primary">${data.team1_wins}</h4>
                    <small class="text-muted">Wins</small>
                </div>
                <div class="col-4">
                    <h6>Draws</h6>
                    <h4 class="text-warning">${data.draws}</h4>
                    <small class="text-muted">Ties</small>
                </div>
                <div class="col-4">
                    <h6>${team2}</h6>
                    <h4 class="text-success">${data.team2_wins}</h4>
                    <small class="text-muted">Wins</small>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-12">
                    <p><strong>Total Matches:</strong> ${data.total_matches}</p>
                    <p><strong>${team1} Win Rate:</strong> ${data.team1_win_rate}%</p>
                    <p><strong>${team2} Win Rate:</strong> ${data.team2_win_rate}%</p>
                    <p><strong>Draw Rate:</strong> ${data.draw_rate}%</p>
                    <p><strong>${team1} Avg Goals:</strong> ${data.avg_goals_team1}</p>
                    <p><strong>${team2} Avg Goals:</strong> ${data.avg_goals_team2}</p>
                    <p><strong>Data Source:</strong> ${data.data_source === 'real_data' ? 'Historical Data' : 'Simulated Data'}</p>
                </div>
            </div>
        `;
        
        summaryDiv.innerHTML = html;
    }

    function createWinRatesChart(data, team1, team2) {
        const ctx = document.getElementById('winRatesChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (winRatesChart) {
            winRatesChart.destroy();
        }
        
        winRatesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [team1, team2, 'Draws'],
                datasets: [{
                    label: 'Win Rate (%)',
                    data: [data.team1_win_rate, data.team2_win_rate, data.draw_rate],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 206, 86, 0.8)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 206, 86, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function displayMatchHistory(matchHistory) {
        const tbody = document.getElementById('matchHistoryBody');
        
        if (!matchHistory || matchHistory.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No match history available</td></tr>';
            return;
        }
        
        const html = matchHistory.map(match => `
            <tr>
                <td>${match.date || 'Unknown'}</td>
                <td>${match.home_team || 'Unknown'}</td>
                <td><strong>${match.home_score || 0} - ${match.away_score || 0}</strong></td>
                <td>${match.away_team || 'Unknown'}</td>
                <td>
                    <span class="badge ${match.winner === 'Draw' ? 'bg-warning' : 'bg-success'}">
                        ${match.winner || 'Unknown'}
                    </span>
                </td>
                <td>
                    <span class="badge ${match.result === 'Home' ? 'bg-primary' : match.result === 'Away' ? 'bg-success' : 'bg-warning'}">
                        ${match.result === 'Home' ? 'Home Win' : match.result === 'Away' ? 'Away Win' : 'Draw'}
                    </span>
                </td>
            </tr>
        `).join('');
        
        tbody.innerHTML = html;
    }

    function displayRecentForm(recentForm, team1, team2) {
        const analysisDiv = document.getElementById('recentFormAnalysis');
        
        if (!recentForm || !recentForm.team1 || !recentForm.team2) {
            analysisDiv.innerHTML = `
                <div class="alert alert-secondary">
                    <h6>Recent Form Analysis</h6>
                    <p class="mb-0">Insufficient recent data to determine form trend.</p>
                </div>
            `;
            return;
        }
        
        // Calculate form points for both teams
        const formPoints = {'W': 3, 'D': 1, 'L': 0};
        const team1Points = recentForm.team1.reduce((sum, result) => sum + formPoints[result], 0);
        const team2Points = recentForm.team2.reduce((sum, result) => sum + formPoints[result], 0);
        
        let formText = '';
        let formClass = '';
        
        if (team1Points > team2Points) {
            formText = `${team1} has been in better form in recent matches.`;
            formClass = 'alert-success';
        } else if (team2Points > team1Points) {
            formText = `${team2} has been in better form in recent matches.`;
            formClass = 'alert-success';
        } else {
            formText = 'Both teams have been evenly matched in recent encounters.';
            formClass = 'alert-warning';
        }
        
        // Create form display
        const team1Form = recentForm.team1.map(result => 
            `<span class="badge ${result === 'W' ? 'bg-success' : result === 'D' ? 'bg-warning' : 'bg-danger'}">${result}</span>`
        ).join(' ');
        
        const team2Form = recentForm.team2.map(result => 
            `<span class="badge ${result === 'W' ? 'bg-success' : result === 'D' ? 'bg-warning' : 'bg-danger'}">${result}</span>`
        ).join(' ');
        
        analysisDiv.innerHTML = `
            <div class="alert ${formClass}">
                <h6>Recent Form Analysis</h6>
                <p class="mb-2">${formText}</p>
                <div class="row">
                    <div class="col-md-6">
                        <strong>${team1} Form:</strong> ${team1Form}
                    </div>
                    <div class="col-md-6">
                        <strong>${team2} Form:</strong> ${team2Form}
                    </div>
                </div>
            </div>
        `;
    }

    function showError(message) {
        errorText.textContent = message;
        errorMessage.classList.remove('d-none');
        resultsSection.classList.add('d-none');
    }
});
</script>
{% endblock %} 