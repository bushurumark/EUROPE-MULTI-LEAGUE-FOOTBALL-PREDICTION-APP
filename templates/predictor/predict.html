{% extends 'predictor/base.html' %}
{% load static %}

{% block title %}Professional Match Predictions{% endblock %}

{% block extra_css %}
<style>
    .prediction-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 40px 0;
    }
    
    .prediction-card {
        background: #fff7ed;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 8px 25px rgba(146, 64, 14, 0.15);
        margin-bottom: 30px;
        border: 2px solid #fed7aa;
    }
    
    .team-selector {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 20px;
        align-items: center;
        margin-bottom: 30px;
    }
    
    .team-card {
        background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
        color: #92400e;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        border: 2px solid #f59e0b;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .team-card:hover {
        border-color: #dc2626;
        box-shadow: 0 8px 25px rgba(220, 38, 38, 0.15);
        transform: translateY(-2px);
    }
    
    .team-card.selected {
        border-color: #dc2626;
        background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
        box-shadow: 0 8px 25px rgba(220, 38, 38, 0.2);
    }
    
    .vs-badge {
        background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 1.2rem;
        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
    }
    
    .form-control, .form-select {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
        background: white;
    }
    
    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    
    .btn-predict {
        background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        border: none;
        padding: 20px 45px;
        border-radius: 20px;
        color: white;
        font-size: 1.3rem;
        font-weight: 700;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 10px 30px rgba(5, 150, 105, 0.4), 0 0 20px rgba(5, 150, 105, 0.2);
        position: relative;
        overflow: hidden;
        display: inline-flex;
        align-items: center;
        gap: 15px;
        text-decoration: none;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        min-width: 300px;
        justify-content: center;
        border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .btn-predict::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.6s;
    }
    
    .btn-predict:hover::before {
        left: 100%;
    }
    
    .btn-predict:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 15px 40px rgba(5, 150, 105, 0.5), 0 0 30px rgba(5, 150, 105, 0.3);
        color: white;
        text-decoration: none;
        background: linear-gradient(135deg, #047857 0%, #059669 100%);
        border-color: rgba(255, 255, 255, 0.2);
    }
    
    .btn-predict:active {
        transform: translateY(-2px) scale(0.98);
        box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4);
    }
    
    .btn-predict i {
        font-size: 1.4rem;
        animation: pulse 2s infinite;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .btn-predict:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
        animation: none;
    }
    
    .btn-predict:disabled:hover {
        transform: none;
        box-shadow: 0 10px 30px rgba(5, 150, 105, 0.4);
    }
    
    /* Glowing effect for the button */
    .btn-predict::after {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #10b981, #059669, #047857, #10b981);
        border-radius: 22px;
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .btn-predict:hover::after {
        opacity: 0.3;
    }
    
    .btn-clear {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-clear:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(100, 116, 139, 0.4);
        color: white;
        text-decoration: none;
    }
    
    .btn-clear:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    
    .stat-item {
        background: #fff7ed;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(146, 64, 14, 0.15);
        border: 2px solid #fed7aa;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
    }
    
    .stat-label {
        color: #92400e;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .team-form {
        background: #fff7ed;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(146, 64, 14, 0.15);
        border: 2px solid #fed7aa;
    }
    
    .form-indicator {
        display: inline-block;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        margin-right: 4px;
        text-align: center;
        line-height: 24px;
        font-weight: bold;
        font-size: 0.8rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }
    
    .form-indicator:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .form-win {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
        color: white !important;
        border: 1px solid #15803d !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    .form-draw {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
        color: white !important;
        border: 1px solid #b45309 !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    .form-loss {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
        color: white !important;
        border: 1px solid #b91c1c !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    

    
    .prediction-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        color: white;
        padding: 30px;
        border-radius: 16px 16px 0 0;
        margin: -40px -40px 30px -40px;
    }
    
    .category-selector {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
    }
</style>
{% endblock %}

{% block content %}
<div class="prediction-container">
    <div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
                <div class="prediction-card">
                    <div class="prediction-header">
                        <h2 class="text-center mb-2">Professional Match Prediction</h2>
                        <p class="text-center mb-0">Professional match predictions</p>
                    </div>
                    
                    <form id="prediction-form" method="post">
                        {% csrf_token %}
                        
                        <!-- Category Selection -->
                        <div class="category-selector">
                            <label for="category" class="form-label">League Category</label>
                            <select name="category" id="category" class="form-control" required>
                                <option value="">Select Category</option>
                                <option value="European Leagues">European Leagues</option>
                                <option value="Others">Other Leagues</option>
                            </select>
                        </div>
                        
                        <!-- League Selection -->
                        <div class="category-selector">
                            <label for="league" class="form-label">League</label>
                            <select name="league" id="league" class="form-control" required>
                                <option value="">Select League</option>
                            </select>
                        </div>
                        
                        <!-- Team Selection -->
                        <div class="team-selector">
                            <div class="team-card">
                                <h4>Home Team</h4>
                                <select name="home_team" id="home_team" class="form-control" required>
                                    <option value="">Select Home Team</option>
                                    </select>
                                <div id="home_stats" class="team-form" style="display: none;">
                                    <h6>Team Statistics</h6>
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-value" id="home_form">-</div>
                                            <div class="stat-label">Recent Form</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value" id="home_goals">-</div>
                                            <div class="stat-label">Avg Goals</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value" id="home_strength">-</div>
                                            <div class="stat-label">Team Strength</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="vs-badge">VS</div>
                            
                            <div class="team-card">
                                <h4>Away Team</h4>
                                <select name="away_team" id="away_team" class="form-control" required>
                                    <option value="">Select Away Team</option>
                                    </select>
                                <div id="away_stats" class="team-form" style="display: none;">
                                    <h6>Team Statistics</h6>
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-value" id="away_form">-</div>
                                            <div class="stat-label">Recent Form</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value" id="away_goals">-</div>
                                            <div class="stat-label">Avg Goals</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value" id="away_strength">-</div>
                                            <div class="stat-label">Team Strength</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prediction Button -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn-predict" id="predict-btn">
                                <i class="fas fa-magic"></i>
                                Generate Professional Prediction
                            </button>
                        </div>
                        
                        <!-- Loading Spinner -->
                        <div class="loading-spinner" id="loading">
                            <div class="spinner"></div>
                            <p class="mt-3">Analyzing match data and generating prediction...</p>
                        </div>
                    </form>
</div>


            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// League data structure - Optimized with lazy loading for European Leagues
const leaguesData = {
    'European Leagues': {
        // Only load the most popular leagues initially
        'Premier League': ['Arsenal', 'Aston Villa', 'Bournemouth', 'Brentford', 'Brighton', 'Chelsea', 'Crystal Palace', 'Everton', 'Fulham', 'Ipswich', 'Leicester', 'Liverpool', 'Man City', 'Man United', 'Newcastle', "Nott'm Forest", 'Southampton', 'Tottenham', 'West Ham', 'Wolves'],
        'Serie A': ['Atalanta', 'Bologna', 'Cagliari', 'Como', 'Empoli', 'Fiorentina', 'Genoa', 'Inter', 'Juventus', 'Lazio', 'Lecce', 'Milan', 'Monza', 'Napoli', 'Parma', 'Roma', 'Torino', 'Udinese', 'Venezia', 'Verona'],
        'La Liga': ['Alaves', 'Ath Bilbao', 'Ath Madrid', 'Barcelona', 'Betis', 'Celta', 'Espanol', 'Getafe', 'Girona', 'Las Palmas', 'Leganes', 'Mallorca', 'Osasuna', 'Real Madrid', 'Sevilla', 'Sociedad', 'Valencia', 'Valladolid', 'Vallecano', 'Villarreal'],
        'Bundesliga': ['Augsburg', 'Bayern Munich', 'Bochum', 'Dortmund', 'Ein Frankfurt', 'Freiburg', 'Heidenheim', 'Hoffenheim', 'Holstein Kiel', 'Leverkusen', 'M\'gladbach', 'Mainz', 'RB Leipzig', 'St Pauli', 'Stuttgart', 'Union Berlin', 'Werder Bremen', 'Wolfsburg']
    },
    'Others': {
        'Switzerland League': ['Basel', 'Grasshoppers', 'Lausanne', 'Lugano', 'Luzern', 'Servette', 'Sion', 'St. Gallen', 'Winterthur', 'Young Boys', 'Yverdon', 'Zurich'],
        'Denmark League': ['Aarhus', 'Midtjylland', 'Nordsjaelland', 'Aalborg', 'Silkeborg', 'Sonderjyske', 'Vejle', 'Randers FC', 'Viborg', 'Brondby', 'Lyngby', 'FC Copenhagen'],
        'Austria League': ['Grazer AK', 'Salzburg', 'Altach', 'Tirol', 'Hartberg', 'LASK', 'Wolfsberger AC', 'A. Klagenfurt', 'BW Linz', 'Austria Vienna', 'SK Rapid', 'Sturm Graz'],
        'Mexico League': ['Puebla', 'Santos Laguna', 'Queretaro', 'Club Tijuana', 'Juarez', 'Atlas', 'Atl. San Luis', 'Club America', 'Guadalajara Chivas', 'Toluca', 'Tigres UANL', 'Necaxa', 'Cruz Azul', 'Mazatlan FC', 'UNAM Pumas', 'Club Leon', 'Pachuca', 'Monterrey'],
        'Russia League': ['Lokomotiv Moscow', 'Akron Togliatti', 'Krylya Sovetov', 'Zenit', 'Dynamo Moscow', 'Fakel Voronezh', 'FK Rostov', 'CSKA Moscow', 'Orenburg', 'Spartak Moscow', 'Akhmat Grozny', 'Krasnodar', 'Khimki', 'Dynamo Makhachkala', 'Pari NN', 'Rubin Kazan'],
        'Romania League': ['Farul Constanta', 'Unirea Slobozia', 'FC Hermannstadt', 'Univ. Craiova', 'Sepsi Sf. Gheorghe', 'Poli Iasi', 'UTA Arad', 'FC Rapid Bucuresti', 'FCSB', 'U. Cluj', 'CFR Cluj', 'Din. Bucuresti', 'FC Botosani', 'Otelul', 'Petrolul', 'Gloria Buzau']
    }
};

// Extended European Leagues data for lazy loading
const extendedEuropeanLeagues = {
    'English Championship': ['Blackburn', 'Derby', 'Preston', 'Sheffield United', 'Cardiff', 'Sunderland', 'Hull', 'Bristol City', 'Leeds', 'Portsmouth', 'Middlesbrough', 'Swansea', 'Millwall', 'Watford', 'Oxford', 'Norwich', 'QPR', 'West Brom', 'Stoke', 'Coventry', 'Sheffield Weds', 'Plymouth', 'Luton', 'Burnley'],
    'Serie B': ['Bari', 'Brescia', 'Carrarese', 'Catanzaro', 'Cesena', 'Cittadella', 'Cosenza', 'Cremonese', 'Frosinone', 'Juve Stabia', 'Mantova', 'Modena', 'Palermo', 'Pisa', 'Reggiana', 'Salernitana', 'Sampdoria', 'Sassuolo', 'Spezia', 'Sudtirol'],
    'Ligue1': ['Angers', 'Auxerre', 'Brest', 'Lens', 'Le Havre', 'Lille', 'Lyon', 'Marseille', 'Monaco', 'Montpellier', 'Nantes', 'Nice', 'Paris SG', 'Reims', 'Rennes', 'St Etienne', 'Strasbourg', 'Toulouse'],
    'Ligue2': ['Ajaccio', 'Rodez', 'Amiens', 'Red Star', 'Clermont', 'Pau FC', 'Dunkerque', 'Annecy', 'Grenoble', 'Laval', 'Guingamp', 'Troyes', 'Caen', 'Paris FC', 'Martigues', 'Lorient', 'Metz', 'Bastia'],
    'La Liga2': ['Albacete', 'Almeria', 'Burgos', 'Cadiz', 'Cartagena', 'Castellon', 'Cordoba', 'Eibar', 'Eldense', 'Elche', 'Ferrol', 'Granada', 'Huesca', 'La Coruna', 'Levante', 'Malaga', 'Mirandes', 'Oviedo', 'Santander', 'Sp Gijon', 'Tenerife', 'Zaragoza'],
    'Eredivisie': ['Ajax', 'Almere City', 'AZ Alkmaar', 'Feyenoord', 'For Sittard', 'Go Ahead Eagles', 'Groningen', 'Heerenveen', 'Heracles', 'NAC Breda', 'Nijmegen', 'PSV Eindhoven', 'Sparta Rotterdam', 'Twente', 'Utrecht', 'Waalwijk', 'Willem II', 'Zwolle'],
    'Bundesliga2': ['Hamburg', 'Schalke 04', 'Hannover', 'Elversberg', 'Kaiserslautern', 'St Pauli', 'Osnabruck', 'Karlsruhe', 'Wehen', 'Magdeburg', 'Fortuna Dusseldorf', 'Hertha', 'Braunschweig', 'Holstein Kiel', 'Greuther Furth', 'Paderborn', 'Hansa Rostock', 'Nurnberg'],
    'Scottish League': ['Aberdeen', 'Celtic', 'Dundee', 'Dundee United', 'Hearts', 'Hibernian', 'Kilmarnock', 'Motherwell', 'Rangers', 'Ross County', 'St Johnstone', 'St Mirren'],
    'Belgium League': ['Anderlecht', 'Antwerp', 'Beerschot VA', 'Cercle Brugge', 'Charleroi', 'Club Brugge', 'Dender', 'Genk', 'Gent', 'Kortrijk', 'Mechelen', 'Oud-Heverlee Leuven', 'St Truiden', 'St. Gilloise', 'Standard', 'Westerlo'],
    'Portuguese League': ['Arouca', 'AVS', 'Benfica', 'Boavista', 'Casa Pia', 'Estoril', 'Estrela', 'Famalicao', 'Farense', 'Gil Vicente', 'Guimaraes', 'Moreirense', 'Nacional', 'Porto', 'Rio Ave', 'Santa Clara', 'Sp Braga', 'Sp Lisbon'],
    'Turkish League': ['Ad. Demirspor', 'Alanyaspor', 'Antalyaspor', 'Besiktas', 'Bodrumspor', 'Buyuksehyr', 'Eyupspor', 'Fenerbahce', 'Galatasaray', 'Gaziantep', 'Goztep', 'Hatayspor', 'Kasimpasa', 'Kayserispor', 'Konyaspor', 'Rizespor', 'Samsunspor', 'Sivasspor', 'Trabzonspor'],
    'Greece League': ['AEK', 'Asteras Tripolis', 'Athens Kallithea', 'Atromitos', 'Lamia', 'Levadeiakos', 'OFI Crete', 'Olympiakos', 'PAOK', 'Panathinaikos', 'Panetolikos', 'Panserraikos', 'Volos NFC', 'Aris']
};

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('prediction-form');
    const loading = document.getElementById('loading');
    const predictBtn = document.getElementById('predict-btn');
    const categorySelect = document.getElementById('category');
    const leagueSelect = document.getElementById('league');
    const homeTeamSelect = document.getElementById('home_team');
    const awayTeamSelect = document.getElementById('away_team');
    
    // Category change handler with lazy loading
    categorySelect.addEventListener('change', function() {
        const category = this.value;
        leagueSelect.innerHTML = '<option value="">Select League</option>';
        homeTeamSelect.innerHTML = '<option value="">Select Home Team</option>';
        awayTeamSelect.innerHTML = '<option value="">Select Away Team</option>';
        
        if (category && leaguesData[category]) {
            // For European Leagues, load additional leagues lazily
            if (category === 'European Leagues') {
                // Load initial leagues
                Object.keys(leaguesData[category]).forEach(league => {
                    const option = document.createElement('option');
                    option.value = league;
                    option.textContent = league;
                    leagueSelect.appendChild(option);
                });
                
                // Load additional leagues after a short delay to improve performance
                setTimeout(() => {
                    Object.keys(extendedEuropeanLeagues).forEach(league => {
                        const option = document.createElement('option');
                        option.value = league;
                        option.textContent = league;
                        leagueSelect.appendChild(option);
                    });
                }, 100);
            } else {
                // For other categories, load all leagues immediately
            Object.keys(leaguesData[category]).forEach(league => {
                const option = document.createElement('option');
                option.value = league;
                option.textContent = league;
                leagueSelect.appendChild(option);
            });
            }
        }
    });
    
    // League change handler with optimized team loading
    leagueSelect.addEventListener('change', function() {
        const category = categorySelect.value;
        const league = this.value;
        homeTeamSelect.innerHTML = '<option value="">Select Home Team</option>';
        awayTeamSelect.innerHTML = '<option value="">Select Away Team</option>';
        
        let teams = [];
        
        if (category && league) {
            // Check main leagues data first
            if (leaguesData[category] && leaguesData[category][league]) {
                teams = leaguesData[category][league];
            }
            // Check extended European leagues data
            else if (category === 'European Leagues' && extendedEuropeanLeagues[league]) {
                teams = extendedEuropeanLeagues[league];
            }
        }
        
        // Load teams efficiently
        if (teams.length > 0) {
            teams.forEach(team => {
                // Add to home team select
                const homeOption = document.createElement('option');
                homeOption.value = team;
                homeOption.textContent = team;
                homeTeamSelect.appendChild(homeOption);
                
                // Add to away team select
                const awayOption = document.createElement('option');
                awayOption.value = team;
                awayOption.textContent = team;
                awayTeamSelect.appendChild(awayOption);
            });
        }
    });
    
    // Team selection handlers
    homeTeamSelect.addEventListener('change', function() {
        updateTeamStats('home', this.value);
    });
    
    awayTeamSelect.addEventListener('change', function() {
        updateTeamStats('away', this.value);
    });
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('ðŸ” Form submission intercepted');
        
        const homeTeam = homeTeamSelect.value;
        const awayTeam = awayTeamSelect.value;
        const category = categorySelect.value;
        
        console.log('ðŸ” Form data:', { homeTeam, awayTeam, category });
        
        if (!homeTeam || !awayTeam) {
            alert('Please select both teams');
            return;
        }
        
        // Show loading
        loading.style.display = 'block';
        predictBtn.style.display = 'none';
        
        // Submit form
        const formData = new FormData(form);
        console.log('ðŸ” FormData created:', formData);
        
        console.log('ðŸ” Making fetch request to: {% url "predictor:api_predict" %}');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        console.log('ðŸ” CSRF Token:', csrfToken);
        
        fetch('{% url "predictor:api_predict" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            console.log('ðŸ” Fetch response status:', response.status);
            console.log('ðŸ” Fetch response headers:', response.headers);
            return response.json();
        })
        .then(data => {
            console.log('ðŸ” Fetch response data:', data);
            if (data.error) {
                if (data.insufficient_data) {
                    // Show insufficient data message
                    alert('Insufficient Data: ' + data.error + '\n\nPlease try teams that are in the historical dataset.');
                } else {
                alert('Error: ' + data.error);
                }
            } else {
                // Redirect to result page
                const params = new URLSearchParams({
                    home_team: homeTeam,
                    away_team: awayTeam,
                    category: category,
                    home_score: data.home_score,
                    away_score: data.away_score,
                    outcome: data.outcome,
                    prediction_number: data.prediction_number,
                    model1_prediction: data.model1_prediction || 'Model Prediction',
                    model1_basis: data.model1_basis || 'Based on historical data analysis',
                    model1_confidence: data.model1_confidence || '',
                    final_prediction: data.final_prediction || '',
                    home_form: data.home_form || '',
                    away_form: data.away_form || ''
                });
                
                window.location.href = '/result/?' + params.toString();
            }
        })
        .catch(error => {
            console.error('ðŸ” Fetch error:', error);
            console.error('ðŸ” Error details:', {
                name: error.name,
                message: error.message,
                stack: error.stack
            });
            alert('An error occurred while making the prediction');
        })
        .finally(() => {
            loading.style.display = 'none';
            predictBtn.style.display = 'block';
        });
    });
    
    function updateTeamStats(teamType, teamName) {
        if (!teamName || !teamName.trim()) {
            document.getElementById(teamType + '_stats').style.display = 'none';
            return;
        }
        
        // Remove any existing error messages
        const statsContainer = document.getElementById(teamType + '_stats');
        const existingMessage = statsContainer.querySelector('.team-message');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        // Fetch real team statistics from API
        fetch(`/api/team-stats/?team=${encodeURIComponent(teamName)}`)
            .then(response => {
                if (response.status === 404) {
                    // No data available for this team - hide the stats section
                    document.getElementById(teamType + '_stats').style.display = 'none';
                    return null;
                }
                return response.json();
            })
            .then(data => {
                console.log('API Response for', teamName, ':', data);
                if (data === null) {
                    // 404 response - stats section already hidden
                    return;
                }
                if (data.error) {
                    // Other error - hide stats section
                    document.getElementById(teamType + '_stats').style.display = 'none';
                    return;
                }
                
                // Use real data from API
        const stats = {
                    form: data.recent_form ? data.recent_form.join('') : '',
                    goals: data.goals_scored_avg ? data.goals_scored_avg.toFixed(1) : '',
                    strength: data.home_strength ? data.home_strength.toFixed(1) + '%' : ''
                };
                console.log('Calculated stats for', teamName, ':', stats);
                updateStatsDisplay(teamType, stats);
            })
            .catch(error => {
                console.error('Error fetching team stats:', error);
                // Hide stats section on error instead of showing false data
                document.getElementById(teamType + '_stats').style.display = 'none';
            });
    }
    
    function updateStatsDisplay(teamType, stats) {
        // Update stats display
        const formElement = document.getElementById(teamType + '_form');
        const goalsElement = document.getElementById(teamType + '_goals');
        const strengthElement = document.getElementById(teamType + '_strength');
        
        console.log('Updating stats for', teamType, ':', stats);
        
        // Create colored form display
        formElement.innerHTML = '';
        if (stats.form && stats.form !== '') {
            console.log('Creating colored form indicators for:', stats.form);
            for (let i = 0; i < stats.form.length; i++) {
                const result = stats.form[i];
                const indicator = document.createElement('span');
                indicator.className = 'form-indicator';
                
                console.log('Processing result:', result);
                
                                        if (result === 'W') {
                            indicator.classList.add('form-win');
                            indicator.textContent = 'W';
                            indicator.style.backgroundColor = '#22c55e';
                            indicator.style.color = 'white';
                            indicator.style.border = '1px solid #15803d';
                            console.log('Added W with form-win class');
                        } else if (result === 'D') {
                            indicator.classList.add('form-draw');
                            indicator.textContent = 'D';
                            indicator.style.backgroundColor = '#f59e0b';
                            indicator.style.color = 'white';
                            indicator.style.border = '1px solid #b45309';
                            console.log('Added D with form-draw class');
                        } else if (result === 'L') {
                            indicator.classList.add('form-loss');
                            indicator.textContent = 'L';
                            indicator.style.backgroundColor = '#ef4444';
                            indicator.style.color = 'white';
                            indicator.style.border = '1px solid #b91c1c';
                            console.log('Added L with form-loss class');
                        } else {
                            indicator.textContent = result;
                            console.log('Added unknown result:', result);
                        }
                
                formElement.appendChild(indicator);
            }
        } else {
            formElement.textContent = 'No data available';
            console.log('No form data available');
        }
        
        goalsElement.textContent = stats.goals;
        strengthElement.textContent = stats.strength;
        document.getElementById(teamType + '_stats').style.display = 'block';
        
        console.log('Form display updated for', teamType);
    }
});
</script>
{% endblock %} 